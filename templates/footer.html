<script>
document.addEventListener('DOMContentLoaded', () => {
    const audioPlayer = document.getElementById("audioPlayer");
    const messageBox = document.getElementById("messageBox");

    const mainPlayerUI = {
        playPauseBtn: document.getElementById("playPauseBtn"),
        progressSlider: document.getElementById("progressSlider"),
        volumeSlider: document.getElementById("volumeSlider"),
        currentTitle: document.getElementById("current-title"),
        currentArtist: document.getElementById("current-artist"),
        playerArt: document.getElementById("player-art"),
        currentTimeEl: document.getElementById("currentTime"),
        durationTimeEl: document.getElementById("durationTime"),
        volumeIcon: document.getElementById("volumeIcon")
    };

    let currentPlaylist = [];
    let currentSongIndex = -1;
    let isPlaying = false;

    function showMessage(msg){
        messageBox.textContent = msg;
        messageBox.classList.add('show');
        setTimeout(()=>messageBox.classList.remove('show'),2000);
    }

    function formatTime(seconds){
        if(isNaN(seconds)||seconds<0) return '0:00';
        const m=Math.floor(seconds/60), s=Math.floor(seconds%60);
        return `${m}:${s<10?'0':''}${s}`;
    }

    function loadSong(index){
        if(index<0||index>=currentPlaylist.length) return;
        currentSongIndex=index;
        const song=currentPlaylist[currentSongIndex];
        audioPlayer.src=song.url;
        audioPlayer.currentTime=0;
        playSong();
        updatePlayerUI();
    }

    function playSong(){
        if(audioPlayer.src){ audioPlayer.play(); isPlaying=true; updatePlayerUI(); }
    }

    function pauseSong(){ audioPlayer.pause(); isPlaying=false; updatePlayerUI(); }

    function nextSong(){ currentSongIndex=(currentSongIndex+1)%currentPlaylist.length; loadSong(currentSongIndex); }
    function prevSong(){ currentSongIndex=(currentSongIndex-1+currentPlaylist.length)%currentPlaylist.length; loadSong(currentSongIndex); }

    function togglePlayPause(){ isPlaying?pauseSong():playSong(); }

    function updatePlayerUI(){
        const song=currentPlaylist[currentSongIndex];
        if(song){
            mainPlayerUI.currentTitle.textContent=song.title;
            mainPlayerUI.currentArtist.textContent=song.artist;
            mainPlayerUI.playerArt.src=song.img;
        }else{
            mainPlayerUI.currentTitle.textContent="No song playing";
            mainPlayerUI.currentArtist.textContent="";
            mainPlayerUI.playerArt.src="";
        }
        mainPlayerUI.playPauseBtn.querySelector('i').className=isPlaying?"fas fa-pause":"fas fa-play";
        mainPlayerUI.progressSlider.value=audioPlayer.duration? (audioPlayer.currentTime/audioPlayer.duration*100):0;
        mainPlayerUI.currentTimeEl.textContent=formatTime(audioPlayer.currentTime);
        mainPlayerUI.durationTimeEl.textContent=formatTime(audioPlayer.duration);
        mainPlayerUI.volumeSlider.value=audioPlayer.volume*100;
    }

    mainPlayerUI.playPauseBtn.addEventListener('click', togglePlayPause);
    mainPlayerUI.nextBtn?.addEventListener('click', nextSong);
    mainPlayerUI.prevBtn?.addEventListener('click', prevSong);
    mainPlayerUI.progressSlider.addEventListener('input',()=>{
        audioPlayer.currentTime=(mainPlayerUI.progressSlider.value/100)*audioPlayer.duration;
    });
    mainPlayerUI.volumeSlider.addEventListener('input',()=>{
        audioPlayer.volume=mainPlayerUI.volumeSlider.value/100;
        updatePlayerUI();
    });

    audioPlayer.addEventListener('timeupdate', updatePlayerUI);

    // --- Song card click ---
    function setupSongs(){
        const songCards=document.querySelectorAll('.song-card');
        currentPlaylist=Array.from(songCards).map(card=>({
            url: card.dataset.song,
            title: card.dataset.title,
            artist: card.dataset.artist,
            img: card.dataset.img
        }));
        songCards.forEach((card,index)=>{
            card.addEventListener('click',()=>loadSong(index));
        });
    }

    setupSongs();

    // --- Artist click ---
    const artistCards=document.querySelectorAll('.artist-card');
    artistCards.forEach(card=>{
        card.addEventListener('click',()=>{
            const artistSection=document.querySelector('.artist-detail-container');
            const homeSection=document.getElementById('homeSection');
            const songsList=document.getElementById('artistSongsList');

            homeSection.style.display='none';
            artistSection.style.display='block';
            document.getElementById('artistName').textContent=card.dataset.name;
            document.getElementById('artistImage').src=card.dataset.img;
            if(card.dataset.verified==='True'){
                document.getElementById('artistVerified').style.display='inline';
            }else{
                document.getElementById('artistVerified').style.display='none';
            }

            // Mock: Get songs from original playlist by artist
            const artistSongs=currentPlaylist.filter(s=>s.artist===card.dataset.name);
            songsList.innerHTML='';
            artistSongs.forEach((s,i)=>{
                const div=document.createElement('div');
                div.className='song-card';
                div.dataset.song=s.url;
                div.dataset.title=s.title;
                div.dataset.artist=s.artist;
                div.dataset.img=s.img;
                div.innerHTML=`<img src="${s.img}" alt="${s.title}"/><div class="song-title">${s.title}</div><div class="artist-name">${s.artist}</div>`;
                div.addEventListener('click',()=>loadSong(currentPlaylist.findIndex(x=>x.url===s.url)));
                songsList.appendChild(div);
            });
        });
    });

    document.getElementById('backToArtists').addEventListener('click',()=>{
        document.getElementById('homeSection').style.display='block';
        document.querySelector('.artist-detail-container').style.display='none';
    });

    // --- Search bar ---
    document.getElementById('searchInput').addEventListener('input',(e)=>{
        const term=e.target.value.toLowerCase();
        document.querySelectorAll('.song-card').forEach(card=>{
            const title=card.dataset.title.toLowerCase();
            const artist=card.dataset.artist.toLowerCase();
            card.style.display=(title.includes(term)||artist.includes(term))?'block':'none';
        });
    });
});
</script>
